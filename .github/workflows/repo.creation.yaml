---
name: Automate Repo Creation
on:
  issues:
    types:
      - opened
jobs:
  create-repo:
    #if: contains(github.event.issue.labels.*.name, 'repo-creation')
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue body
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        
      - name: Validate parsed result
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "buc_code=${{ steps.issue-parser.outputs.issueparser_buc_code }}"
          echo "repository_name=${{ steps.issue-parser.outputs.issueparser_repository_name }}"
          echo "repo_description=$(echo "${{ steps.issue-parser.outputs.issueparser_repo_description }}" | sed 's/"/\\"/g')"
          echo "visibility=$(echo "${{ steps.issue-parser.outputs.issueparser_visibility }}" | sed 's/"/\\"/g')"

          if [ -z "${{ steps.issue-parser.outputs.issueparser_buc_code }}" ]; then
            echo "ðŸ‘·ðŸ¼â€â™‚ï¸ FIS_IssueOps Error: BUC Code is required. Ticket will be closed, please create new ticket with correct info."| gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body-file=-
            exit 1
          fi
          if [ -z "${{ steps.issue-parser.outputs.issueparser_repository_name }}" ]; then
            echo "ðŸ‘·ðŸ¼â€â™‚ï¸ FIS_IssueOps Error: Repository Name is required. Ticket will be closed, please create new ticket with correct info."| gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body-file=-
            exit 1
          fi
          if [ -z "${{ steps.issue-parser.outputs.issueparser_repo_description }}" ]; then
            echo "ðŸ‘·ðŸ¼â€â™‚ï¸ FIS_IssueOps Error: Repository Description is required. Ticket will be closed, please create new ticket with correct info."| gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body-file=-
            exit 1
          fi
      - name: Create repository using GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.CREATE_REPO_SECRET }}
        run: >
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
           -d '{
             "name": "${{ steps.issue-parser.outputs.issueparser_repository_name }}",
             "description": "${{ steps.issue-parser.outputs.issueparser_repo_description }}",
             "auto_init": true, 
             "private": "${{ steps.issue-parser.outputs.issueparser_visibility }} == 'private'"
           }' https://api.github.com/user/repos

      - name: Add labels
        if: ${{ steps.issue-parser.outputs.issueparser_buc_code != '' }}
        run: |
          IFS=',' read -ra LABELS <<< "${{ steps.issue-parser.outputs.issueparser_buc_code }}"
          for label in "${LABELS[@]}"; do
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$label\", \"color\": \"f29513\"}" \
              https://api.github.com/repos/${{ github.repository_owner }}/${{ steps.issue-parser.outputs.issueparser_repository_name }}/labels
          done
      
