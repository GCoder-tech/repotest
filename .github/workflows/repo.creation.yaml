---
name: Automate Repo Creation
on:
  issues:
    types:
      - opened
jobs:
  create-repo:
    #if: contains(github.event.issue.labels.*.name, 'repo-creation')
    runs-on: ubuntu-latest
    steps:
      - name: Get issue content
        id: issue
        run: |
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Body: ${{ github.event.issue.body }}"

      - name: Parse issue content
        id: parse
        run: |
          repository_name = $(echo "${{ github.event.issue.body }}" | grep -A 1 '### Repository Name' | tail -n 1)"
          repo_description = $(echo "${{ github.event.issue.body }}" | grep -A 1 '### Repo Description' | tail -n 1)"
          visbility = $(echo "${{ github.event.issue.body }}" | grep -A 1 '### Visibility' | tail -n 1)"
          
      - name: Output parsed content
        run: |
          echo "Repository Name: ${{ steps.parse.outputs.repository_name }}"
          echo "Repo Description: ${{ steps.parse.outputs.repo_description }}"
          echo "Repo Visbility: ${{ steps.parse.outputs.visibility }}"
          
      - name: Create repository using GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.CREATE_REPO_SECRET }}
        run: >
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
           -d '{
             "name": "${{ steps.parse.outputs.repository_name }}",
             "description": "${{ steps.parse.outputs.repo_description }}",
             "auto_init": true 
             "private": ${{ steps.parse.outputs.visibility == 'private' }}
           }' https://api.github.com/user/repos
      - name: Rename default branch to main
        run: >
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"new_name": "main"}' \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.repoName }}/branches/main/rename
