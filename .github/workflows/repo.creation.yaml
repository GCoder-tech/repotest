---
name: Automate Repo Creation
on:
  issues:
    types:
      - opened
jobs:
  create-repo:
    #if: contains(github.event.issue.labels.*.name, 'repo-creation')
    runs-on: ubuntu-latest
    steps:
      - name: Get issue content
        id: issue
        run: |
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Body: ${{ github.event.issue.body }}"

      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Parse issue content
        id: parse
        run: |
          echo "${{ github.event.issue.body }}" > issue_body.txt
          python ./script/parse_issue.py

      - name: Output parsed content
        run: |
          echo "Description: ${{ steps.parse.outputs.description }}"
          echo "Use case: ${{ steps.parse.outputs.use_case }}"
          echo "Additional context: ${{ steps.parse.outputs.additional_context }}"
          
      - name: Create repository using GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.CREATE_REPO_SECRET }}
        run: >
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
           -d '{
             "name": "${{ steps.parse.outputs.repository_name }}",
             "description": "${{ steps.parse.outputs.repo_description }}",
             "auto_init": true 
             "private": ${{ steps.parse.outputs.visibility == 'private' }}
           }' https://api.github.com/user/repos
      - name: Rename default branch to main
        run: >
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"new_name": "main"}' \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.repoName }}/branches/main/rename
